{
    "schema_path": "config/table_schemas_gen.json",
    "analyses": {
      "bins_analysis": {
        "table": "merged*stats.bins_v1",
        "metrics": [
          {"name": "total_allocated", "column": "allocated_3", "operation": "sum"},
          {"name": "avg_utilization", "column": "util_16", "operation": "avg"},
          {"name": "total_slabs", "column": "curslabs_12", "operation": "sum"}
        ],
        "groupby": ["bins_0", "size_1"]
      },
      "bins_total": {
        "table": "merged*stats.bins_v1",
        "metrics": [
          {"name": "total_allocated", "column": "allocated_3", "operation": "sum"},
          {"name": "avg_utilization", "column": "util_16", "operation": "avg"},
          {"name": "total_slabs", "column": "curslabs_12", "operation": "sum"},
          {"name": "total_non_full_slabs", "column": "nonfull_slabs_13", "operation": "sum"}
        ],
        "groupby": ["timestamp"]
      },
      "arena_efficiency": {
        "table": "*overall",
        "metrics": [
          {"name": "allocation_rate", "column": "nmalloc_1", "operation": "sum"},
          {"name": "deallocation_rate", "column": "ndalloc_3", "operation": "sum"},
          {"name": "net_allocation", "operation": "custom", "formula": "SUM(nmalloc_1) - SUM(ndalloc_3)"}
        ],
        "groupby": ["timestamp"]
      },
      "fragmentation_analysis": {
        "table": "merged_arena_stats.bins_v1",
        "metrics": [
          {
            "name": "fragmentation_score",
            "operation": "expression",
            "formula": {
              "row_operation": "CAST(nonfull_slabs_13 AS FLOAT) / NULLIF(curslabs_12, 0)",
              "aggregation": "avg",
              "filter": "curslabs_12 >= 5", 
              "having": "> 0.3" 
            }
          },
          {
            "name": "wasted_slabs",
            "operation": "sum",
            "column": "nonfull_slabs_13"
          },
          {
            "name": "total_memory_waste",
            "operation": "expression",
            "formula": {
              "row_operation": "size_1 * regs_14 * nonfull_slabs_13 * (1 - util_16)",
              "aggregation": "sum"
            }
          }
        ],
        "groupby": ["bins_0", "size_1"]
      },
      "bin_pages_analysis": {
            "table": "merged_arena_stats.bins_v1",
            "metrics": [
                {
                    "name": "bin_size",
                    "operation": "max",
                    "column": "size_1"
                },
                {
                    "name": "total_pages",
                    "operation": "expression",
                    "formula": {
                        "row_operation": "pgs_15 * curslabs_12",
                        "aggregation": "sum"
                    }
                },
                {
                    "name": "total_slabs",
                    "operation": "sum",
                    "column": "curslabs_12"
                },
                {
                    "name": "pages_per_slab",
                    "operation": "max",
                    "column": "pgs_15"
                },
                {
                    "name": "utilization",
                    "operation": "avg",
                    "column": "util_16"
                },
                {
                    "name": "total_allocated",
                    "operation": "sum",
                    "column": "allocated_3"
                }
            ],
            "groupby": ["bins_0"],
            "sort": {
                "by": "total_pages",  
                "order": "desc"         
            },
            "special": "memory_pages"
    },
    "bin_activity_analysis": {
            "table": "merged_arena_stats.bins_v1",
            "metrics": [
                {
                    "name": "bin_size",
                    "operation": "max",
                    "column": "size_1"
                },
                {
                    "name": "total_requests",
                    "operation": "sum",
                    "column": "nrequests_8"
                },
                {
                    "name": "alloc_ops",
                    "operation": "sum",
                    "column": "nmalloc_4"
                },
                {
                    "name": "dealloc_ops",
                    "operation": "sum",
                    "column": "ndalloc_6"
                },
                {
                    "name": "fills",
                    "operation": "sum",
                    "column": "nfills_17"
                },
                {
                    "name": "flushes",
                    "operation": "sum",
                    "column": "nflushes_19"
                },
                {
                    "name": "lock_ops",
                    "operation": "sum",
                    "column": "n_lock_ops_24"
                },
                {
                    "name": "owner_switches",
                    "operation": "sum",
                    "column": "n_owner_switch_30"
                }
            ],
            "groupby": ["bins_0"],
            "sort": {
                "by": "total_requests",  
                "order": "desc"         
            },
            "special": "activity"
        },
        "bin_activity_analysis_new": {
                "table": "merged_arena_stats.bins_v1",
                "metrics": [
                    {
                        "name": "bin_size",
                        "operation": "max",
                        "column": "size_1"
                    },
                    {
                        "name": "total_requests",
                        "operation": "sum",
                        "column": "nrequests_8"
                    },
                    {
                        "name": "alloc_ops",
                        "operation": "sum",
                        "column": "nmalloc_4"
                    },
                    {
                        "name": "dealloc_ops",
                        "operation": "sum",
                        "column": "ndalloc_6"
                    },
                    {
                        "name": "fills",
                        "operation": "sum",
                        "column": "nfills_17"
                    },
                    {
                        "name": "flushes",
                        "operation": "sum",
                        "column": "nflushes_19"
                    },
                    {
                        "name": "slab_ops_ratio",
                        "operation": "expression",
                        "formula": {
                            "row_operation": "CAST((nfills_17 + nflushes_19) AS FLOAT) / NULLIF(nrequests_8, 0) * 100.0",
                            "aggregation": "avg"
                        }
                    },
                    {
                        "name": "lock_ops",
                        "operation": "sum",
                        "column": "n_lock_ops_24"
                    },
                    {
                        "name": "owner_switches",
                        "operation": "sum",
                        "column": "n_owner_switch_30"
                    },
                    {
                        "name": "alloc_rate",
                        "operation": "max",
                        "column": "rps_5"
                    },
                    {
                        "name": "dealloc_rate",
                        "operation": "max",
                        "column": "rps_7"
                    },
                    {
                        "name": "fill_rate",
                        "operation": "max",
                        "column": "rps_18"
                    },
                    {
                        "name": "flush_rate",
                        "operation": "max",
                        "column": "rps_20"
                    }
                ],
                "groupby": ["bins_0"],
                "sort": {
                    "by": "slab_ops_ratio",  
                    "order": "desc"
                }
            },
        
    "high_contention_bins": {
        "table": "merged_arena_stats.bins_v1",
        "metrics": [
          {
            "name": "allocation_rate",
            "operation": "expression",
            "formula": {
              "row_operation": "nmalloc_4",
              "aggregation": "sum",
              "filter": "n_lock_ops_24 > 1000"  
            }
          },
          {
            "name": "lock_contention",
            "operation": "expression",
            "formula": {
              "row_operation": "CAST(n_waiting_26 AS FLOAT) / NULLIF(n_lock_ops_24, 0)",
              "aggregation": "avg",
              "having": "> 0.1"  
            }
          },
          {
            "name": "total_wait_time",
            "operation": "sum",
            "column": "total_wait_ns_32"
          }
        ],
        "groupby": ["bins_0", "size_1"]
      },
      "inefficient_bins": {
        "table": "merged_arena_stats.bins_v1",
        "metrics": [
          {
            "name": "total_allocated",
            "operation": "sum",
            "column": "allocated_3"
          },
          {
            "name": "avg_utilization",
            "operation": "expression",
            "formula": {
              "row_operation": "util_16",
              "aggregation": "avg",
              "filter": "allocated_3 > 1000",  
              "having": "< 0.5"  
            }
          },
          {
            "name": "wasted_memory",
            "operation": "expression",
            "formula": {
              "row_operation": "allocated_3 * (1 - util_16)",
              "aggregation": "sum"
            }
          }
        ],
        "groupby": ["bins_0", "size_1"]
      },
        "arena_comparison": {
            "table": "arenas_*.overall", 
            "metrics": [
                {
                    "name": "total_allocated",
                    "operation": "sum",
                    "column": "allocated_0"
                },
                {
                    "name": "allocation_rate",
                    "operation": "sum",
                    "column": "nmalloc_1"
                },
                {
                    "name": "deallocation_rate",
                    "operation": "sum",
                    "column": "ndalloc_3"
                },
                {
                    "name": "memory_percent",
                    "operation": "expression",
                    "formula": {
                        "row_operation": "CAST(allocated_0 AS FLOAT) * 100.0 / SUM(allocated_0) OVER ()",
                        "aggregation": "avg"
                    }
                }
            ],
            "groupby": ["arena_id"],
            "special": "arena_pattern"
        },
        "slab_efficiency_analysis": {
                "table": "merged_arena_stats.bins_v1",
                "metrics": [
                    {
                        "name": "bin_size",
                        "operation": "max",
                        "column": "size_1"
                    },
                    {
                        "name": "total_requests",
                        "operation": "sum",
                        "column": "nrequests_8"
                    },
                    {
                        "name": "total_slab_ops",
                        "operation": "expression",
                        "formula": {
                            "row_operation": "nfills_17 + nflushes_19",
                            "aggregation": "sum"
                        }
                    },
                    {
                        "name": "slab_ops_ratio",
                        "operation": "expression",
                        "formula": {
                            "row_operation": "CAST((nfills_17 + nflushes_19) AS FLOAT) / NULLIF(nrequests_8, 0) * 100.0",
                            "aggregation": "avg"
                        }
                    },
                    {
                        "name": "fills",
                        "operation": "sum",
                        "column": "nfills_17"
                    },
                    {
                        "name": "flushes",
                        "operation": "sum",
                        "column": "nflushes_19"
                    },
                    {
                        "name": "utilization",
                        "operation": "avg",
                        "column": "util_16"
                    }
                ],
                "groupby": ["bins_0"],
                "sort": [
                    {
                        "by": "total_requests",
                        "order": "desc"
                    }
                ]

            }
    }
  }