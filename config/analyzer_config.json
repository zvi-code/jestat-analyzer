{
    "schema_path": "config/table_schemas_gen.json",
    "analyses": {
      "bins_analysis": {
        "table": "merged*stats__bins_v1",
        "metrics": [
          {"name": "total_allocated", "column": "allocated", "operation": "sum"},
          {"name": "avg_utilization", "column": "util", "operation": "avg"},
          {"name": "total_slabs", "column": "curslabs", "operation": "sum"}
        ],
        "groupby": ["bins", "size"]
      },
      "bins_total": {
        "table": "merged*stats__bins_v1",
        "metrics": [
          {"name": "total_allocated", "column": "allocated", "operation": "sum"},
          {"name": "avg_utilization", "column": "util", "operation": "avg"},
          {"name": "total_slabs", "column": "curslabs", "operation": "sum"},
          {"name": "total_non_full_slabs", "column": "nonfull_slabs", "operation": "sum"}
        ],
        "groupby": ["timestamp"]
      },
      "arena_efficiency": {
        "table": "*overall",
        "metrics": [
          {"name": "allocation_rate", "column": "nmalloc", "operation": "sum"},
          {"name": "deallocation_rate", "column": "ndalloc", "operation": "sum"},
          {"name": "net_allocation", "operation": "custom", "formula": "SUM(nmalloc) - SUM(ndalloc)"}
        ],
        "groupby": ["timestamp"]
      },
      "fragmentation_analysis": {
        "table": "stats-merged_arena_stats__bins_v1",
        "metrics": [
          {
            "name": "fragmentation_score",
            "operation": "expression",
            "formula": {
              "row_operation": "CAST(nonfull_slabs AS FLOAT) / NULLIF(curslabs, 0)",
              "aggregation": "avg",
              "filter": "curslabs >= 5", 
              "having": "> 0.3" 
            }
          },
          {
            "name": "wasted_slabs",
            "operation": "sum",
            "column": "nonfull_slabs"
          },
          {
            "name": "total_memory_waste",
            "operation": "expression",
            "formula": {
              "row_operation": "size * regs * nonfull_slabs * (1 - util)",
              "aggregation": "sum"
            }
          }
        ],
        "groupby": ["bins", "size"]
      },
      "bin_pages_analysis": {
            "table": "stats-merged_arena_stats__bins_v1",
            "metrics": [
                {
                    "name": "bin_size",
                    "operation": "max",
                    "column": "size"
                },
                {
                    "name": "total_pages",
                    "operation": "expression",
                    "formula": {
                        "row_operation": "pgs * curslabs",
                        "aggregation": "sum"
                    }
                },
                {
                    "name": "total_slabs",
                    "operation": "sum",
                    "column": "curslabs"
                },
                {
                    "name": "pages_per_slab",
                    "operation": "max",
                    "column": "pgs"
                },
                {
                    "name": "utilization",
                    "operation": "avg",
                    "column": "util"
                },
                {
                    "name": "total_allocated",
                    "operation": "sum",
                    "column": "allocated"
                }
            ],
            "groupby": ["bins"],
            "sort": {
                "by": "total_pages",  
                "order": "desc"         
            },
            "special": "memory_pages"
    },
    "bin_activity_analysis": {
            "table": "stats-merged_arena_stats__bins_v1",
            "metrics": [
                {
                    "name": "bin_size",
                    "operation": "max",
                    "column": "size"
                },
                {
                    "name": "total_requests",
                    "operation": "sum",
                    "column": "nrequests"
                },
                {
                    "name": "alloc_ops",
                    "operation": "sum",
                    "column": "nmalloc"
                },
                {
                    "name": "dealloc_ops",
                    "operation": "sum",
                    "column": "ndalloc"
                },
                {
                    "name": "fills",
                    "operation": "sum",
                    "column": "nfills"
                },
                {
                    "name": "flushes",
                    "operation": "sum",
                    "column": "nflushes"
                },
                {
                    "name": "lock_ops",
                    "operation": "sum",
                    "column": "n_lock_ops"
                },
                {
                    "name": "owner_switches",
                    "operation": "sum",
                    "column": "n_owner_switch"
                },
                {
                    "name": "total_pages",
                    "operation": "expression",
                    "formula": {
                        "row_operation": "pgs * curslabs",
                        "aggregation": "sum"
                    }
                },
                {
                    "name": "total_allocated",
                    "operation": "sum",
                    "column": "allocated"
                },
                {
                    "name": "utilization",
                    "operation": "avg",
                    "column": "util"
                }

            ],
            "groupby": ["bins"],
            "sort": {
                "by": "total_requests",  
                "order": "desc"         
            },
            "special": "activity"
        },
        "bin_activity_analysis_new": {
                "table": "stats-merged_arena_stats__bins_v1",
                "metrics": [
                    {
                        "name": "bin_size",
                        "operation": "max",
                        "column": "size"
                    },
                    {
                        "name": "total_requests",
                        "operation": "sum",
                        "column": "nrequests"
                    },
                    {
                        "name": "alloc_ops",
                        "operation": "sum",
                        "column": "nmalloc"
                    },
                    {
                        "name": "dealloc_ops",
                        "operation": "sum",
                        "column": "ndalloc"
                    },
                    {
                        "name": "fills",
                        "operation": "sum",
                        "column": "nfills"
                    },
                    {
                        "name": "flushes",
                        "operation": "sum",
                        "column": "nflushes"
                    },
                    {
                        "name": "tcache_batch_cost",
                        "operation": "expression",
                        "formula": {
                            "row_operation": "CAST((nfills + nflushes) AS FLOAT) / NULLIF(nrequests, 0) * 100.0",
                            "aggregation": "avg"
                        }
                    },
                    {
                        "name": "tcache_alloc_amort",
                        "operation": "expression",
                        "formula": {
                            "row_operation": "CAST((nfills) AS FLOAT) / NULLIF(nmalloc, 0) * 100.0",
                            "aggregation": "avg"
                        }
                    },                    
                    {
                        "name": "tcache_dealloc_amort",
                        "operation": "expression",
                        "formula": {
                            "row_operation": "CAST((nflushes) AS FLOAT) / NULLIF(ndalloc, 0) * 100.0",
                            "aggregation": "avg"
                        }
                    },
                    {
                        "name": "lock_ops",
                        "operation": "sum",
                        "column": "n_lock_ops"
                    },
                    {
                        "name": "owner_switches",
                        "operation": "sum",
                        "column": "n_owner_switch"
                    },
                    {
                        "name": "alloc_rate",
                        "operation": "max",
                        "column": "rps_nmalloc"
                    },
                    {
                        "name": "dealloc_rate",
                        "operation": "max",
                        "column": "rps_ndalloc"
                    },
                    {
                        "name": "fill_rate",
                        "operation": "max",
                        "column": "rps_nfills"
                    },
                    {
                        "name": "flush_rate",
                        "operation": "max",
                        "column": "rps_nflushes"
                    },
                    {
                        "name": "total_pages",
                        "operation": "expression",
                        "formula": {
                            "row_operation": "pgs * curslabs",
                            "aggregation": "sum"
                        }
                    },
                    {
                        "name": "total_allocated",
                        "operation": "sum",
                        "column": "allocated"
                    },
                    {
                        "name": "utilization",
                        "operation": "avg",
                        "column": "util"
                    }
                ],
                "groupby": ["bins"],
                "sort": [{
                    "by": "tcache_batch_cost",  
                    "order": "desc"
                },
                {
                    "by": "tcache_alloc_amort",  
                    "order": "desc"
                },
                {
                    "by": "tcache_dealloc_amort",  
                    "order": "desc"
                }]
            },
        
    "high_contention_bins": {
        "table": "stats-merged_arena_stats__bins_v1",
        "metrics": [
          {
            "name": "allocation_rate",
            "operation": "expression",
            "formula": {
              "row_operation": "nmalloc",
              "aggregation": "sum",
              "filter": "n_lock_ops > 1000"  
            }
          },
          {
            "name": "lock_contention",
            "operation": "expression",
            "formula": {
              "row_operation": "CAST(n_waiting AS FLOAT) / NULLIF(n_lock_ops, 0)",
              "aggregation": "avg",
              "having": "> 0.1"  
            }
          },
          {
            "name": "total_wait_time",
            "operation": "sum",
            "column": "total_wait_ns"
          }
        ],
        "groupby": ["bins", "size"]
      },
      "inefficient_bins": {
        "table": "stats-merged_arena_stats__bins_v1",
        "metrics": [
          {
            "name": "total_allocated",
            "operation": "sum",
            "column": "allocated"
          },
          {
            "name": "avg_utilization",
            "operation": "expression",
            "formula": {
              "row_operation": "util",
              "aggregation": "avg",
              "filter": "allocated > 1000",  
              "having": "< 0.5"  
            }
          },
          {
            "name": "wasted_memory",
            "operation": "expression",
            "formula": {
              "row_operation": "allocated * (1 - util)",
              "aggregation": "sum"
            }
          }
        ],
        "groupby": ["bins", "size"]
      },
        "arena_comparison": {
            "table": "arenas_*__overall", 
            "metrics": [
                {
                    "name": "total_allocated",
                    "operation": "sum",
                    "column": "allocated"
                },
                {
                    "name": "allocation_rate",
                    "operation": "sum",
                    "column": "nmalloc"
                },
                {
                    "name": "deallocation_rate",
                    "operation": "sum",
                    "column": "ndalloc"
                },
                {
                    "name": "memory_percent",
                    "operation": "expression",
                    "formula": {
                        "row_operation": "CAST(allocated AS FLOAT) * 100.0 / SUM(allocated) OVER ()",
                        "aggregation": "avg"
                    }
                }
            ],
            "groupby": ["arena_id"],
            "special": "arena_pattern"
        },
        "slab_efficiency_analysis": {
                "table": "stats-merged_arena_stats__bins_v1",
                "metrics": [
                    {
                        "name": "bin_size",
                        "operation": "max",
                        "column": "size"
                    },
                    {
                        "name": "total_requests",
                        "operation": "sum",
                        "column": "nrequests"
                    },
                    {
                        "name": "total_slab_ops",
                        "operation": "expression",
                        "formula": {
                            "row_operation": "nfills + nflushes",
                            "aggregation": "sum"
                        }
                    },
                    {
                        "name": "slab_ops_ratio",
                        "operation": "expression",
                        "formula": {
                            "row_operation": "CAST((nfills + nflushes) AS FLOAT) / NULLIF(nrequests, 0) * 100.0",
                            "aggregation": "avg"
                        }
                    },
                    {
                        "name": "fills",
                        "operation": "sum",
                        "column": "nfills"
                    },
                    {
                        "name": "flushes",
                        "operation": "sum",
                        "column": "nflushes"
                    },
                    {
                        "name": "utilization",
                        "operation": "avg",
                        "column": "util"
                    }
                ],
                "groupby": ["bins"],
                "sort": [
                    {
                        "by": "total_requests",
                        "order": "desc"
                    }
                ]

            }
    }
  }